{% macro card_overview(card, request) -%}
<a href="{{ url_for('card', key=card.key) }}" title="{{ card.key }} -- {{ card.title }}{% if card.blocked %} BLOCKED: {{ card.blockers[-1].reason }}{% endif %}">
    {% set vs_goal = card.cycle_vs_goal %}
    {% if vs_goal == 2 %}
        {% set classname = "cycle_double_over_goal" %}
    {% elif vs_goal == 1 %}
        {% set classname = "cycle_over_goal" %}
    {% elif vs_goal == 0 %}
        {% set classname = "cycle_in_goal" %}
    {% endif %}
    {% if card.blocked %}
        {% set symbol = "#9635;" %}
    {% else %}
        {% set symbol = "#9724;" %}
    {% endif %}
    <span class="card_icon {{ classname }}">&{{ symbol }}</span>
</a>
{%- endmacro %}

{% macro card_detail(card, request) -%}
    {% set vs_goal = card.cycle_vs_goal %}
    <div class="card_on_board {% if vs_goal == 2 %}cycle_double_over_goal{% elif vs_goal == 1 %}cycle_over_goal{% elif vs_goal == 0 %}cycle_in_goal{% endif %} card_type_{{ card.service_class|slugify }}" id="card_{{ card.key }}">
        <div class="card_key"><span>{{ card.key }}</span>
            {% if card.done_date %}
                - {{ card.cycle_time }}d
            {% elif card.start_date %}
                - {{ card.current_cycle_time() }}d
            {% elif card.backlog_date %}
                {% if card.priority %}
                - #{{ card.priority }}
                {% endif %}
            {% endif %}
        </div>

        <p class="title"><a href="{{ url_for('card', key=card.key) }}">{{ card.title }}</a></p>

        {% if card.blocked %}
        <div class="blocker">

            <p>{{ card.blockers[-1].reason }}</p>
        </div>
        {% endif %}

        {% set assignee = card.assignee %}
        <p class="assignee">
            {% set version = card.version %}
            {% if version %}{{ version }} &ndash; {% endif %}
            {{ card.service_class }}
            {% if assignee %}<br /><a href="{{ url_for('person', name=assignee) }}">{{ assignee }}</a>{% endif %}
        </p>

    </div>
    </a>
{%- endmacro %}

{% macro board(board, request) -%}
<table class="board">
<tr>
  {% for header in board.headers %}
    {% if header.get('state', '') not in ('OTIS Verify', 'Resolved') %}
    <th>
        {% if header.get('label') %}
            {{ header.label }}
        {% elif header.get('state', '') in ('Build to OTIS', 'Building') %}
            {{ header.state }} ({{ header.count }})<br />
            {{ board.headers[loop.index0+1].state }} ({{ board.headers[loop.index0+1].count }})
        {% else %}
            {{ header.state }} ({{ header.count }})
        {% endif %}

    </th>
    {% endif %}
  {% endfor %}
</tr>

{% for row in board %}
<tr>
{% for cell in row %}
    {% if cell.get('label') %}
        <td class="team">{{ cell['label'] }}</td>
    {% elif cell.get('state', '') not in ('OTIS Verify', 'Resolved') %}
        <td class="cards">
        {% for card in cell['cards'] %}
            {% if board.teams|length > 1 %}
                {{ card_overview(card, request) }}
            {% else %}
                {{ card_detail(card, request) }}
            {% endif %}
        {% endfor %}
        {% if cell.get('state', '') in ('Build to OTIS', 'Building') %}
            {% if cell['cards']|length > 0 %}<hr />{% endif %}
            {% for card in row[loop.index0+1]['cards'] %}
                {% if board.teams|length > 1 %}
                    {{ card_overview(card, request) }}
                {% else %}
                    {{ card_detail(card, request) }}
                {% endif %}
            {% endfor %}
        {% endif %}
        </td>
    {% endif %}
{% endfor %}

</tr>
{% endfor %}

</table>

{%- endmacro %}